<!DOCTYPE html>
<html lang="en" style="background: url('../assets/MostlySecurity-WideFree.png') no-repeat left center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;">
<head>
    <meta charset="utf-8">
    <title>Mostly Security - Episode</title>
    <meta name="description" content="Mostly Security Episode">
    <meta name="author" content="Mostly Security">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../normalize.css">
    <link rel="stylesheet" href="../skeleton.css">
    <link rel="stylesheet" href="../mostlysecurity.css">
    <link rel="stylesheet" href="episode.css">
    <link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicons/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#232323">
    <meta name="msapplication-TileImage" content="../favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#232323">
</head>
<body>
    <div class="container" style="margin-top: 20pt;">
        
        <div class="row header">
            <div class="twelve columns" id="episode-container">
                <!-- Single episode will be rendered here -->
            </div>
            <div id="loader" style="display: none;">Loading...</div>
            <div id="message-box"></div>
        </div>
        <div class="row header" style="margin-top: 10pt;">
            <div class="twelve columns">
                <a href="/episodes/" style="color: #fff;">&larr; Back to All Episodes</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const episodeNumber = params.get('episode');
            
            const episodeContainer = document.getElementById('episode-container');
            const messageBox = document.getElementById('message-box');
            const loader = document.getElementById('loader');

            const setLoadingState = (isLoading) => {
                loader.style.display = isLoading ? 'block' : 'none';
                if (isLoading) {
                    messageBox.innerHTML = '';
                }
            };

            const showMessage = (message) => {
                messageBox.innerHTML = message;
            };

            if (!episodeNumber) {
                showMessage('No episode number provided. Please specify an episode, e.g., episode.html?episode=162');
                return;
            }

            const rssUrl = "https://feeds.libsyn.com/121466/rss";
            setLoadingState(true);

            try {
                let response = await fetch(rssUrl, { redirect: 'follow' });
                if (response.redirected) {
                    response = await fetch(response.url);
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const str = await response.text();
                const data = new window.DOMParser().parseFromString(str, "text/xml");

                const items = Array.from(data.querySelectorAll("item"));
                const itunesEpisodeSelector = "*|episode"
                const targetEpisode = items.find(item => {
                    const itunesEpisode = item.querySelector(itunesEpisodeSelector)?.textContent || '';
                    const match = itunesEpisode == episodeNumber;
                    return match;
                });

                if (targetEpisode) {
                    renderEpisode(targetEpisode);
                } else {
                    showMessage(`Episode ${episodeNumber} not found.`);
                }

            } catch (error) {
                console.error("Error fetching or parsing RSS feed:", error);
                showMessage('Failed to fetch or parse the RSS feed.');
            } finally {
                setLoadingState(false);
            }
        });

        function renderEpisode(item) {
            const episodeContainer = document.getElementById('episode-container');
            const title = item.querySelector("title")?.textContent || 'No title';
            const pubDate = item.querySelector("pubDate")?.textContent ? new Date(item.querySelector("pubDate").textContent).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'No date';
            const descriptionNode = item.querySelector("description");
            const duration = item.querySelector("duration")?.textContent || '';
            const descriptionHtml = descriptionNode?.textContent || '<p>No description available.</p>';
            const enclosure = item.querySelector("enclosure");
            const mp3Url = enclosure?.getAttribute('url');
            let downloadLinkHtml = '';
            if (mp3Url) {
                downloadLinkHtml = `<a href="${mp3Url}" download>Download</a>`;
            }

            const card = document.createElement('div');
            card.className = 'bgshade black'; // Use a consistent color for the single view
            card.innerHTML = `
                <strong class="episode">${title}</strong>
                <div class="episode-date">${pubDate}</div>
                <div class="episode-length">${duration ? `Time: ${duration} &nbsp;&nbsp;` : ''} ${downloadLinkHtml}</div>
                <div class="episode-description">${descriptionHtml}</div>
                <audio controls preload="auto" src="${mp3Url}"></audio>
            `;
            episodeContainer.appendChild(card);
            document.title = `Mostly Security - ${title}`; // Update page title
        }
    </script>
</body>
</html>
